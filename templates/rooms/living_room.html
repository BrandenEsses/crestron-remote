{% extends "layout/page.html" %}
{% block title %}Living Room{% endblock %}

{% block content %}
<div class="bg-base-200 shadow-lg rounded-lg p-6 space-y-6">
  <h1 class="text-4xl font-bold text-center">Living Room</h1>
  <hr />

  <!-- TV Power -->
  <section class="text-center">
    <h3 class="text-2xl font-semibold">TV Power</h3>
    <div class="inline-flex space-x-4 mt-2">
      <button id="tv_power_on" class="btn btn-success btn-lg" onClick="reply_click(this.id)"><i class="fas fa-power-off"></i> On</button>
      <button id="tv_power_off" class="btn btn-error btn-lg" onClick="reply_click(this.id)"><i class="fas fa-power-off"></i> Off</button>
    </div>
  </section>

  <!-- Source Select -->
  <section class="text-center">
    <h3 class="text-2xl font-semibold">Source Select</h3>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-2">
      <button id="apple_tv_source_select" class="btn btn-primary btn-lg" onClick="reply_click(this.id)"><i class="fab fa-apple"></i> Apple TV</button>
      <button id="chromecast_source_select" class="btn btn-primary btn-lg" onClick="reply_click(this.id)"><i class="fab fa-chromecast"></i> Chromecast</button>
      <button id="branden_desktop_source_select" class="btn btn-primary btn-lg" onClick="reply_click(this.id)"><i class="fas fa-desktop"></i> Branden's PC</button>
      <button id="sarah_pc_source_select" class="btn btn-primary btn-lg" onClick="reply_click(this.id)"><i class="fas fa-laptop"></i> Sarah's PC</button>
      <button id="tv_hdmi_2" class="btn btn-primary btn-lg" onClick="reply_click(this.id)"><i class="fas fa-exchange-alt"></i> Switch</button>
    </div>
  </section>

  <!-- Soundbar Volume -->
  <section class="text-center">
    <h3 class="text-2xl font-semibold">Soundbar Volume</h3>
    <div class="inline-flex space-x-4 mt-2">
      <button id="soundbar_vol_mute" class="btn btn-outline btn-lg" onClick="reply_click(this.id)"><i class="bi bi-volume-mute-fill"></i></button>
      <button id="soundbar_vol_down" class="btn btn-outline btn-lg" onClick="reply_click(this.id)"><i class="bi bi-volume-down-fill"></i></button>
      <button id="soundbar_vol_up" class="btn btn-outline btn-lg" onClick="reply_click(this.id)"><i class="bi bi-volume-up-fill"></i></button>
    </div>
  </section>

  <!-- Lights Controls -->
  <section class="text-center">
    <h3 class="text-2xl font-semibold">Lights</h3>
    <div class="mt-2 space-y-3">
      <div class="inline-flex space-x-4">
        <button id="living_room_on" class="btn btn-success btn-lg" onClick="hue(this.id)">On</button>
        <button id="living_room_off" class="btn btn-error btn-lg" onClick="hue(this.id)">Off</button>
      </div>
      <input id="brightness_range" type="range" min="0" max="254" step="1" class="range range-primary w-full" onChange="hue(this.id, this.value)" />
      <input id="color_range" type="color" class="w-full h-12 p-0 rounded" onChange="hue(this.id, this.value)" />
    </div>
  </section>

  <!-- Control Panels (modals) -->
  <section class="text-center space-y-4">

    <!-- TV Controls Modal -->
    <label for="TVModal" class="btn btn-secondary btn-lg">TV Controls</label>
    <input type="checkbox" id="TVModal" class="modal-toggle" />
    <div class="modal modal-bottom sm:modal-middle">
      <div class="modal-box">
        <h3 class="font-bold text-lg">TV Controls</h3>
        <div class="mt-4 space-y-6">
          <div class="text-center space-x-2">
            <button id="tv_power_on" class="btn btn-success" onClick="reply_click(this.id)">On</button>
            <button id="tv_power_off" class="btn btn-error" onClick="reply_click(this.id)">Off</button>
            <button id="tv_home" class="btn" onClick="reply_click(this.id)">Home</button>
            <button id="tv_menu" class="btn" onClick="reply_click(this.id)">Menu</button>
            <button id="tv_back" class="btn" onClick="reply_click(this.id)">Back</button>
            <button id="tv_play_pause" class="btn" onClick="reply_click(this.id)">Play/Pause</button>
          </div>
          <div class="text-center">
            <h4 class="font-semibold uppercase tracking-wide text-sm text-base-content/70">TV Inputs</h4>
            <div class="mt-2 grid grid-cols-2 gap-2 md:grid-cols-4">
              <button id="tv_hdmi_1" class="btn btn-primary" onClick="reply_click(this.id)">HDMI 1</button>
              <button id="tv_hdmi_2" class="btn btn-primary" onClick="reply_click(this.id)">HDMI 2</button>
              <button id="tv_hdmi_3" class="btn btn-primary" onClick="reply_click(this.id)">HDMI 3</button>
              <button id="tv_hdmi_4" class="btn btn-primary" onClick="reply_click(this.id)">HDMI 4</button>
            </div>
          </div>
          <div class="text-center">
            <h4 class="font-semibold uppercase tracking-wide text-sm text-base-content/70">Switcher Inputs</h4>
            <div class="mt-2 grid grid-cols-2 gap-2 md:grid-cols-4">
              <button id="hd-md4x1-input-1" class="btn btn-outline" onClick="reply_click(this.id)">HDMI 1</button>
              <button id="hd-md4x1-input-2" class="btn btn-outline" onClick="reply_click(this.id)">HDMI 2</button>
              <button id="hd-md4x1-input-3" class="btn btn-outline" onClick="reply_click(this.id)">HDMI 3</button>
              <button id="hd-md4x1-input-4" class="btn btn-outline" onClick="reply_click(this.id)">HDMI 4</button>
            </div>
          </div>
        </div>
        <!-- Draggable D-pad for TV -->
        <div id="tv_dpad" class="mx-auto mt-6 w-40 h-40 bg-base-300 rounded-full relative touch-none">
          <div id="tv_dot" class="absolute w-12 h-12 bg-primary rounded-full shadow-lg" style="top:calc(50% - 24px); left:calc(50% - 24px); touch-action: none;"></div>
        </div>
        <div class="modal-action">
          <label for="TVModal" class="btn">Close</label>
        </div>
      </div>
    </div>

    <!-- Chromecast Modal -->
    <!--
    <label for="chromecastModal" class="btn btn-secondary btn-lg">Chromecast Controls</label>
    <input type="checkbox" id="chromecastModal" class="modal-toggle" />
    <div class="modal modal-bottom sm:modal-middle">
      <div class="modal-box">
        <h3 class="font-bold text-lg">Chromecast Controls</h3>
        <div class="space-x-2 mt-4 text-center">
          <button id="adb_chromecast_home" class="btn btn-primary" onClick="reply_click(this.id)"><i class="bi bi-house-fill"></i></button>
          <button id="adb_chromecast_back" class="btn btn-primary" onClick="reply_click(this.id)"><i class="bi bi-arrow-return-left"></i></button>
          <button id="adb_chromecast_play_pause" class="btn btn-primary" onClick="reply_click(this.id)"><i class="bi bi-play-fill"></i><i class="bi bi-pause-fill"></i></button>
        </div>
        <div id="chromecast_dpad" class="mx-auto mt-6 w-40 h-40 bg-base-300 rounded-full relative touch-none">
          <div id="chromecast_dot" class="absolute w-12 h-12 bg-primary rounded-full shadow-lg" style="top:calc(50% - 24px); left:calc(50% - 24px); touch-action: none;"></div>
        </div>
        <div class="modal-action">
          <label for="chromecastModal" class="btn">Close</label>
        </div>
      </div>
    </div>
    -->

    <!-- Apple TV Modal with draggable D-pad -->
    <label for="appleTVModal" class="btn btn-secondary btn-lg">Apple TV Controls</label>
    <input type="checkbox" id="appleTVModal" class="modal-toggle" />
    <div class="modal modal-bottom sm:modal-middle">
      <div class="modal-box">
        <h3 class="font-bold text-lg">Apple TV Controls</h3>
        <div class="space-x-2 mt-4 text-center">
          <button id="apple_tv_home" class="btn btn-primary" onClick="reply_click(this.id)"><i class="bi bi-house-fill"></i></button>
          <button id="apple_tv_back" class="btn btn-primary" onClick="reply_click(this.id)"><i class="bi bi-arrow-return-left"></i></button>
          <button id="apple_tv_play_pause" class="btn btn-primary" onClick="reply_click(this.id)"><i class="bi bi-play-fill"></i><i class="bi bi-pause-fill"></i></button>
        </div>
        <div id="apple_tv_dpad" class="mx-auto mt-6 w-40 h-40 bg-base-300 rounded-full relative touch-none">
          <div id="apple_tv_dot" class="absolute w-12 h-12 bg-primary rounded-full shadow-lg" style="top:calc(50% - 24px); left:calc(50% - 24px); touch-action: none;"></div>
        </div>
        <div class="modal-action">
          <label for="appleTVModal" class="btn">Close</label>
        </div>
      </div>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script defer>
  // Draggable logic for TV D-pad
  (function(){ const d=document.getElementById('tv_dpad'), o=document.getElementById('tv_dot');let start,delta;
    o.addEventListener('pointerdown',e=>{e.target.setPointerCapture(e.pointerId);start={x:e.offsetX,y:e.offsetY};delta={x:0,y:0};});
    o.addEventListener('pointermove',e=>{if(!start)return;const r=d.getBoundingClientRect();let dx=e.clientX-r.left-start.x,dy=e.clientY-r.top-start.y;const m=(r.width-o.offsetWidth)/2,dist=Math.hypot(dx,dy);if(dist>m){dx=dx/dist*m;dy=dy/dist*m;}delta={x:dx,y:dy};o.style.transform=`translate(${dx}px,${dy}px)`;});
    o.addEventListener('pointerup',e=>{e.target.releasePointerCapture(e.pointerId);if(!start)return;const x=delta?delta.x:0,y=delta?delta.y:0;let dir='tv_select';if(Math.abs(x)>Math.abs(y)&&Math.abs(x)>10){dir=x<0?'tv_left':'tv_right';}else if(Math.abs(y)>Math.abs(x)&&Math.abs(y)>10){dir=y<0?'tv_up':'tv_down';}reply_click(dir);o.style.transform='translate(0,0)';start=null;delta=null;});
  })();
  /*
  // Draggable logic for Chromecast D-pad
  (function(){ const d=document.getElementById('chromecast_dpad'), o=document.getElementById('chromecast_dot');let s;
    o.addEventListener('pointerdown',e=>{e.target.setPointerCapture(e.pointerId);s={x:e.offsetX,y:e.offsetY};});
    o.addEventListener('pointermove',e=>{if(!s)return;const r=d.getBoundingClientRect();let dx=e.clientX-r.left-s.x,dy=e.clientY-r.top-s.y;const m=(r.width-o.offsetWidth)/2,dist=Math.hypot(dx,dy);if(dist>m){dx=dx/dist*m;dy=dy/dist*m;}o.style.transform=`translate(${dx}px,${dy}px)`;});
    o.addEventListener('pointerup',e=>{e.target.releasePointerCapture(e.pointerId);if(!s)return;const m=/translate\((-?\d+)px,(-?\d+)px\)/.exec(o.style.transform)||[0,0,0],x=+m[1],y=+m[2],dir=Math.abs(x)>Math.abs(y)&&Math.abs(x)>10?x<0?'adb_chromecast_left':'adb_chromecast_right':Math.abs(y)>Math.abs(x)&&Math.abs(y)>10?y<0?'adb_chromecast_up':'adb_chromecast_down':'adb_chromecast_select';reply_click(dir);o.style.transform='translate(0,0)';s=null;});
  })();
  */
  // Draggable logic for Apple TV D-pad
  (function(){ const d=document.getElementById('apple_tv_dpad'), o=document.getElementById('apple_tv_dot');let start,delta;
    o.addEventListener('pointerdown',e=>{e.target.setPointerCapture(e.pointerId);start={x:e.offsetX,y:e.offsetY};delta={x:0,y:0};});
    o.addEventListener('pointermove',e=>{if(!start)return;const r=d.getBoundingClientRect();let dx=e.clientX-r.left-start.x,dy=e.clientY-r.top-start.y;const m=(r.width-o.offsetWidth)/2,dist=Math.hypot(dx,dy);if(dist>m){dx=dx/dist*m;dy=dy/dist*m;}delta={x:dx,y:dy};o.style.transform=`translate(${dx}px,${dy}px)`;});
    o.addEventListener('pointerup',e=>{e.target.releasePointerCapture(e.pointerId);if(!start)return;const x=delta?delta.x:0,y=delta?delta.y:0;let dir='apple_tv_select';if(Math.abs(x)>Math.abs(y)&&Math.abs(x)>10){dir=x<0?'apple_tv_left':'apple_tv_right';}else if(Math.abs(y)>Math.abs(x)&&Math.abs(y)>10){dir=y<0?'apple_tv_up':'apple_tv_down';}reply_click(dir);o.style.transform='translate(0,0)';start=null;delta=null;});
  })();
  // fetch helpers
  async function reply_click(id){try{await fetch(`/living_room_join_handler?button=${id}`,{method:'POST'});}catch(e){console.error(e);}}
  async function hue(id,value){const url=id==='color_range'?`/hue?color=${value.substring(1)}`:id==='brightness_range'?`/hue?brightness=${value}`:`/hue?button=${id}`;try{await fetch(url,{method:'POST'});}catch(e){console.error(e);}}
  // Hue sync
  function hue_status_sync(){fetch('/hue?status').then(r=>r.json()).then(d=>{document.getElementById('color_range').value=d.hue;document.getElementById('brightness_range').value=d.brightness;}).catch(e=>console.error(e));}
  setInterval(hue_status_sync,5000);
</script>
{% endblock %}
